<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<entity size="0.6/0.6" origin="0.3/0.3" blocking="yes">
	<properties>
		<position default="1/1" type="vector2f" predict="yes" />
		<rotation type="float" unlocked="yes" updatelocally="no" />
		<team default="0" type="uint" size="4" />
		<currentweapon default="-1" type="int" size="4" />
		<keys default="0" type="uint" size="8" unlocked="yes" updatelocally="no" />
		<health default="100" type="uint" size="8" />
		<weapon0 default="65535" type="uint" size="16" />
		<weapon1 default="65535" type="uint" size="16" />
	</properties>

	<image name="feet" src="sprites/feet.png" position="-0.5/-0.5" rotate="no" depth="1.5" />
	<animation name="feetanim" image="feet" size="4/2" stopped="yes" depth="0.5" period="1000" />
	<image name="body" src="sprites/player.png" position="-0.5/-0.5" rotate="no" depth="1.5" />
	<image name="weapon" position="-0.5/-0.5" rotate="no" depth="1.6" />

	<script>
	<![CDATA[
		function on_loaded()
			print("Entity loaded.");
			if Client ~= nil then
				print("Entity: Client.");
				if this:isLocal() then
					print("Entity: local.");
					Game.get():setInputTarget(this);
				end
			end
			if Server ~= nil then
			end
		end
		function on_changed(property)
			if property:getName() == "rotation" then
				if Client ~= nil then
					body:setRotation(0);
					body:setPosition(-0.5, -0.5);
					body:rotate(property:getFloat() + 180, 0.5, 0.5);
					weapon:setRotation(0);
					weapon:setPosition(-0.5, -0.5);
					weapon:rotate(property:getFloat() + 180, 0.5, 0.5);
				end
			end
			-- Movement
			if property:getName() == "keys" then
				yspeed = 0;
				xspeed = 0;
				-- Get movement speed
				if keys:bit(0) == true then
					yspeed = yspeed + 1;
				end
				if keys:bit(1) == true then
					yspeed = yspeed - 1;
				end
				if keys:bit(2) == true then
					xspeed = xspeed + 1;
				end
				if keys:bit(3) == true then
					xspeed = xspeed - 1;
				end
				-- Set movement
				this:setSpeed(Vector2F(xspeed, yspeed), false);
				if Client ~= nil then
					feet:setRotation(0);
					feet:setPosition(-0.5, -0.5);
					if xspeed ~= 0 or yspeed ~= 0 then
						if not feetanim:isPlaying() then
							feetanim:start();
						end
						feet:rotate(Vector2F(yspeed, -xspeed):getRotation(), 0.5, 0.5);
					else
						if feetanim:isPlaying() then
							feetanim:stop();
						end
					end
				end
				if Server ~= nil then
					-- Shooting
					if keys:bit(4) == true then
					end
				end
			end
			if property:getName() == "currentweapon" then
				print("Weapon changed. "..currentweapon:getInt())
				weaponentity = Game.get():getEntity(currentweapon:getInt())
				if Client ~= nil then
					-- TODO: Change HUD
					-- Change weapon texture
					local textureid = weaponentity:getScript():callFunctionInt("get_player_texture")
					texture = Texture.get(textureid)
					weapon:setTexture(texture)
					print("Texture. "..textureid)
				end
			end
		end
		function on_set_weapon(weapon)
			print("on_set_weapon")
			currentweapon:setInt(weapon)
		end
		function on_mouse_input(rotangle)
			rotation:setFloat(rotangle)
		end
		function on_keyboard_input(key, state)
			print("Keyboard input.")
			if key == "up" then
				keys:bit(1, state)
			elseif key == "down" then
				keys:bit(0, state)
			elseif key == "left" then
				keys:bit(3, state)
			elseif key == "right" then
				keys:bit(2, state)
			end
		end
	]]>
	</script>
</entity>
