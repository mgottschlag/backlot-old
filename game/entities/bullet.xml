<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<entity size="0.2/0.2" origin="0.1/0.1">
	<properties>
		<weapon default="65535" type="uint" size="16" />
		<player default="65535" type="uint" size="16" />
		<start default="0/0" type="vector2f" />
		<speed default="0/0" type="vector2f" />
	</properties>
	<image name="bulletimage" src="sprites/plasma.png" position="-0.1/-0.1" size="0.2/0.2" depth="1.5" />
	<script>
	<![CDATA[
		time = 0
		position = start:getVector2F()

		function on_changed(property)
			print(property:getName().." changed.")
		end
		function on_update()
			local oldpos = start:getVector2F() + speed:getVector2F() * (time / 50)
			time = time + 1;
			local newpos = start:getVector2F() + speed:getVector2F() * (time / 50)
			-- Collision checking
			local collision = Game.get():getCollision(oldpos, newpos, 1)
			if collision.collision then
				-- Register bullet for deletion
				if Server ~= nil then
					Game.get():registerForDeletion(this:getID())
					-- TODO: Do damage
				end
			end
			-- Set new position
			position = newpos
			if Client ~= nil then
				bulletimage:setPosition(position)
			end
			-- Check for entity hits
			local rect = this:getRectangle();
			rect.x = rect.x + position.x
			rect.y = rect.y + position.y
			local entitylist = Game.get():getEntities(rect, "player");
			if entitylist:getSize() > 0 then
				-- Don't hit yourself
				local playerentity = Game.get():getEntity(player:getInt())
				entitylist:removeEntity(playerentity)
				if entitylist:getSize() > 0 then
					print("Player hit!")
					if Server ~= nil then
						Game.get():registerForDeletion(this:getID())
					end
					-- TODO: Do damage
				end
			end
		end
	]]>
	</script>
</entity>
